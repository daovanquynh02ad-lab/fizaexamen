<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Imed - Физиология</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&family=Noto+Serif:wght@700&display=swap" rel="stylesheet">

    <script src="questions.js"></script>

    <style>
        /* БАЗА И ФИКСАЦИЯ */
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; touch-action: manipulation; }

        html, body {
            position: fixed; top: 0; left: 0; width: 100%; height: 100dvh;
            overflow: hidden; overscroll-behavior: none;
            background-color: #000; color: #000; font-family: 'Inter', sans-serif;
        }

        #mobile-wrapper {
            width: 100%; max-width: 480px; height: 100%;
            background-color: #fff; margin: 0 auto;
            display: flex; flex-direction: column; position: relative;
        }
        @media (min-width: 481px) { #mobile-wrapper { box-shadow: 0 0 50px rgba(255,255,255,0.1); } }
        .dark #mobile-wrapper { background-color: #000; }

        /* --- ХЕДЕР: СЛЕВА, КОМПАКТНЫЙ, ОДИН РЯД --- */
        .layout-header {
            flex-shrink: 0; width: 100%;
            /* Отступ только системный + чуть-чуть воздуха */
            padding-top: calc(env(safe-area-inset-top) + 10px);
            padding-bottom: 10px;
            padding-left: 16px;
            padding-right: 16px;
            background-color: inherit; z-index: 50;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid rgba(0,0,0,0.05);
            height: auto;
            min-height: 60px; /* Фиксируем минимальную высоту для удобства нажатия */
        }
        .dark .layout-header { border-bottom: 1px solid rgba(255,255,255,0.1); }

        /* КОНТЕНТ */
        .layout-content {
            flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch;
            width: 100%; position: relative; padding: 0;
            padding-bottom: 180px !important; 
        }
        .layout-content::-webkit-scrollbar { display: none; }

        /* ПОДВАЛ */
        .layout-footer {
            position: absolute; bottom: 0; left: 0; width: 100%;
            padding: 16px; padding-bottom: calc(env(safe-area-inset-bottom) + 20px);
            background-color: inherit; z-index: 100;
            border-top: 1px solid rgba(0,0,0,0.05);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
        }
        .dark .layout-footer { border-top: 1px solid rgba(255,255,255,0.1); }

        /* КЛИК */
        .btn-click { transition: transform 0.05s ease; cursor: pointer; user-select: none; }
        .btn-click:active { transform: scale(0.96); opacity: 0.8; }

        /* 3D */
        .perspective-1000 { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; }
        .backface-hidden { -webkit-backface-visibility: hidden; backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }

        /* АНИМАЦИИ */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.25s ease-out; }
        @keyframes pulseText { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .animate-pulse-text { animation: pulseText 2s infinite ease-in-out; }

        #intro-layer, #auth-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        #intro-video { width: 100%; height: 100%; object-fit: cover; position: absolute; }
        #start-text { z-index: 10000; cursor: pointer; position: absolute; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .hidden-force { display: none !important; }
        #app { width: 100%; height: 100%; display: flex; flex-direction: column; }
    </style>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { gold: '#FFD700' } } }
        }
    </script>
</head>
<body class="bg-slate-50 text-slate-900 transition-colors duration-300 selection:bg-[#FFD700] selection:text-black">

<div id="mobile-wrapper" class="bg-slate-50 dark:bg-black">
    <!-- ИНТРО -->
    <div id="intro-layer">
        <video id="intro-video" playsinline preload="auto" muted><source src="intro.mp4" type="video/mp4"></video>
        <div id="start-text" onclick="userClickedStart()">
            <div class="text-white font-bold text-base tracking-[0.2em] uppercase animate-pulse-text text-center px-4">Нажмите, чтобы начать</div>
        </div>
    </div>
    <!-- ЗАГРУЗКА -->
    <div id="auth-screen" class="hidden-force bg-slate-50 dark:bg-black">
        <div class="animate-spin text-indigo-600 mb-4"><i data-lucide="loader-2" class="w-10 h-10"></i></div>
        <p class="text-slate-500 font-medium">Проверка доступа...</p>
    </div>
    <!-- ПРИЛОЖЕНИЕ -->
    <div id="app" class="hidden-force"></div>
</div>

<script>
const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzaq2gIrn50O6-2_8DH5Gy-1UpeT8BYFwcPvIasPKfBXT5shXnBSPbTWWPsOOUkor78/exec";
let accessData = null; let videoFinished = false; let accessError = null;
const tg = window.Telegram.WebApp;
try { tg.expand(); tg.requestFullscreen(); if(tg.isVerticalSwipesEnabled!==undefined) tg.isVerticalSwipesEnabled=false; tg.setHeaderColor('#ffffff'); } catch(e){}

function haptic(type='light') {
    if(tg.HapticFeedback) {
        if(type==='error') tg.HapticFeedback.notificationOccurred('error');
        else if(type==='success') tg.HapticFeedback.notificationOccurred('success');
        else tg.HapticFeedback.impactOccurred(type);
    } else if(navigator.vibrate) navigator.vibrate(10);
}

document.addEventListener('touchstart', (e)=>{if(e.touches[0].clientX<40){window.sx=e.touches[0].clientX;window.sy=e.touches[0].clientY;window.sw=true}else{window.sw=false}},{passive:true});
document.addEventListener('touchend', (e)=>{if(!window.sw)return;const ex=e.changedTouches[0].clientX;const ey=e.changedTouches[0].clientY;if((ex-window.sx)>60 && Math.abs(ey-window.sy)<50){haptic('medium');goHome();}window.sw=false},{passive:true});

async function userClickedStart() {
    haptic('medium'); document.getElementById('start-text').remove();
    const vid=document.getElementById('intro-video');
    try { vid.muted=false; await vid.play(); vid.onended=()=>{videoFinished=true;checkStateTransition();}; } 
    catch(err){ videoFinished=true; checkStateTransition(); }
    performAccessCheck();
}

async function performAccessCheck() {
    if(typeof physiology_questions==='undefined'){ accessError={type:'file',msg:'Файл questions.js не найден.'};checkStateTransition();return;}
    const userId = tg.initDataUnsafe?.user?.id || new URLSearchParams(window.location.search).get('userId');
    if(window.location.protocol==='file:'){ accessData={allowed:true};processQuestions();checkStateTransition();return;}
    if(!userId){ accessError={type:'browser',msg:'Зайдите через Telegram.'};checkStateTransition();return;}
    
    const ck = `imed_access_v1_${userId}`; const c = localStorage.getItem(ck);
    if(c){ try{const p=JSON.parse(c);if(p.allowed){accessData=p;processQuestions();checkStateTransition();return;}}catch(e){localStorage.removeItem(ck);} }

    try{
        const ctrl=new AbortController(); setTimeout(()=>ctrl.abort(),15000);
        const res=await fetch(`${GOOGLE_SCRIPT_URL}?userId=${userId}`,{signal:ctrl.signal});
        const data=await res.json();
        if(data.allowed){ accessData=data; localStorage.setItem(ck,JSON.stringify(data)); processQuestions(); }
        else accessError={type:'denied',msg:'Доступ закрыт.'};
    } catch(e){ accessError={type:'network',msg:'Ошибка сети.'}; }
    checkStateTransition();
}

function checkStateTransition() {
    if(!videoFinished) return;
    const intro=document.getElementById('intro-layer'), auth=document.getElementById('auth-screen'), app=document.getElementById('app');
    if(accessError){ if(intro) intro.style.display='none'; auth.classList.remove('hidden-force'); auth.innerHTML=`<div class="p-6 text-center"><h1 class="text-2xl font-bold mb-2">Ошибка</h1><p>${accessError.msg}</p></div>`; return; }
    if(accessData){
        if(intro){ intro.style.transition='opacity 0.5s'; intro.style.opacity='0'; setTimeout(()=>{intro.style.display='none';app.classList.remove('hidden-force');init();},500); }
        else { app.classList.remove('hidden-force'); init(); }
    } else { if(intro) intro.style.display='none'; auth.classList.remove('hidden-force'); }
}

const TOPIC_MAP = [
    { pages: 3,  title: "1. Биологические мембраны и транспорт веществ" },       
    { pages: 4,  title: "2. Клеточные рецепторы и внутриклеточная сигнализация" },                 
    { pages: 5,  title: "3. Физиология клетки и тканей" },             
    { pages: 15, title: "4. Анатомия опорно-двигательного аппарата" },              
    { pages: 2,  title: "5. Анатомия дыхательной системы" },       
    { pages: 7,  title: "6. Анатомия желудочно-кишечного тракта" },              
    { pages: 2,  title: "7. Анатомия выделительной системы" },     
    { pages: 4,  title: "8. Анатомия сердечно-сосудистой системы" },              
    { pages: 22, title: "9. Физиология крови: форменные элементы" },  
    { pages: 15, title: "10. Буферные системы крови и группы крови" }, 
    { pages: 10, title: "11. Физиология сердца: автоматизм и возбудимость" },        
    { pages: 10, title: "12. Регуляция сердечной деятельности" },         
    { pages: 13, title: "13. Гемодинамика и микроциркуляция" },             
    { pages: 4,  title: "14. Регуляция кровообращения" }, 
    { pages: 19, title: "15. Функции почек и мочеобразование" },            
    { pages: 9,  title: "16. Регуляция функции почек" },           
    { pages: 11, title: "17. Пищеварение в полости рта и желудке" },
    { pages: 14, title: "18. Пищеварение в кишечнике, роль поджелудочной и печени" },   
    { pages: 16, title: "19. Регуляция пищеварения и всасывание" },     
    { pages: 7,  title: "20. Обмен веществ и питание" },             
    { pages: 10, title: "21. Обмен энергии и термометрия" },            
    { pages: 9,  title: "22. Терморегуляция" },            
    { pages: 18, title: "23. Физиология дыхания: вентиляция легких" },       
    { pages: 7,  title: "24. Газообмен в легких и тканях" },                
    { pages: 8,  title: "25. Транспорт газов кровью (Гемоглобин)" },                
    { pages: 8,  title: "26. Регуляция дыхания" },        
    { pages: 7,  title: "27. Общая физиология эндокринной системы" },      
    { pages: 12, title: "28. Частная физиология эндокринных желез" },    
    { pages: 19, title: "29. Физиология возбудимых тканей" },             
    { pages: 10, title: "30. Нервные волокна и синаптическая передача" },            
    { pages: 10, title: "31. Физиология мышц и мышечного сокращения" },           
    { pages: 10, title: "32. ЦНС: Нейроны и нервные центры" },      
    { pages: 11, title: "33. ЦНС: Рефлекторная деятельность и торможение" }, 
    { pages: 18, title: "34. Частная физиология ЦНС (Спинной и головной мозг)" },    
    { pages: 18, title: "35. Вегетативная нервная система (ВНС)" },                       
    { pages: 11, title: "36. Сенсорные системы: общие принципы" },  
    { pages: 4,  title: "37. Обонятельная и вкусовая сенсорные системы" },            
    { pages: 4,  title: "38. Соматосенсорная система и физиология боли" },                  
    { pages: 14, title: "39. Зрительная сенсорная система" },                   
    { pages: 6,  title: "40. Слуховая и вестибулярная системы" },        
    { pages: 6,  title: "41. ВНД: Условные и безусловные рефлексы" },     
    { pages: 16, title: "42. ВНД: Типы, память, сон, эмоции" },     
    { pages: 17, title: "43. Адаптация и экологическая физиология" },     
    { pages: 52, title: "44. Возрастная физиология" }     
];

function escapeHtml(t) { if(!t)return""; return t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;"); }
function processQuestions() {
    if (typeof physiology_questions === 'undefined') return;
    const totalPages = TOPIC_MAP.reduce((s, t) => s + t.pages, 0);
    const qPerPage = physiology_questions.length / totalPages;
    let acc = 0;
    const RANGES = TOPIC_MAP.map(t => { const s=acc; acc+=Math.round(t.pages*qPerPage); return {title:t.title,start:s,end:acc}; });
    if (RANGES.length) RANGES[RANGES.length-1].end = physiology_questions.length;
    QUESTIONS_DATA = physiology_questions.map((q, i) => {
        const t = RANGES.find(r => i >= r.start && i < r.end) || RANGES[RANGES.length-1];
        let correct = []; if (q.answer) correct = String(q.answer).split(',').map(s => parseInt(s.trim())-1).filter(n=>!isNaN(n));
        return { id: q.id, topic: t?t.title:"Общее", question: escapeHtml(q.question), options: (q.options||[]).map(o=>escapeHtml(o.replace(/^\d+\)\s*/,''))), correctIndices: correct, image: q.image };
    });
    availableTopics = [...new Set(QUESTIONS_DATA.map(q => q.topic))];
    state.selectedTopics = [...availableTopics];
}

const state = {
    view: 'menu', isDark: false, showFilterModal: false, selectedTopics: [],
    userProgress: {}, resumeState: null, playableQuestions: [],
    currentQuestionIndex: 0, quizFinished: false, sessionAnswers: {},
    selectedOptions: [], isAnswerChecked: false, lastResult: false,
    isShuffleEnabled: false, comboStreak: 0, hideAnswersInLearn: false,
    isFlipped: false, swipeX: 0, animState: 'idle'
};

function init() { render(); }
function toggleTheme() {
    haptic('light'); state.isDark = !state.isDark;
    if(state.isDark) { document.documentElement.classList.add('dark'); if(document.getElementById('auth-screen')) document.getElementById('auth-screen').style.backgroundColor='#000'; try{tg.setHeaderColor('#000000');}catch(e){} }
    else { document.documentElement.classList.remove('dark'); if(document.getElementById('auth-screen')) document.getElementById('auth-screen').style.backgroundColor='#fff'; try{tg.setHeaderColor('#ffffff');}catch(e){} }
    render();
}
function toggleFilterModal(show) { if(show)haptic('light'); state.showFilterModal=show; render(); }
function toggleShuffle() { haptic('light'); state.isShuffleEnabled=!state.isShuffleEnabled; render(); }
function toggleTopic(t) { if(state.selectedTopics.includes(t)) state.selectedTopics=state.selectedTopics.filter(x=>x!==t); else state.selectedTopics.push(t); if(state.showFilterModal) updateTopicListUI(); else render(); }
function toggleSelectAllTopics() { haptic('medium'); if(state.selectedTopics.length===availableTopics.length) state.selectedTopics=[]; else state.selectedTopics=[...availableTopics]; if(state.showFilterModal){updateTopicListUI();updateSelectAllButtonUI();} else render(); }

function updateTopicListUI() {
    const list=document.getElementById('topics-list'); if(!list)return;
    list.querySelectorAll('button[data-topic]').forEach(btn => {
        const t=btn.getAttribute('data-topic'), sel=state.selectedTopics.includes(t), icon=btn.querySelector('.icon-area');
        if(sel) { btn.className="w-full text-left px-4 py-3 rounded-xl font-bold text-sm flex items-center justify-between gap-3 group btn-click bg-black text-white dark:bg-white dark:text-black"; if(icon) icon.innerHTML='<i data-lucide="check-circle" class="w-4 h-4 flex-shrink-0"></i>'; }
        else { btn.className="w-full text-left px-4 py-3 rounded-xl font-bold text-sm flex items-center justify-between gap-3 group btn-click bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 text-slate-700 dark:text-slate-300"; if(icon) icon.innerHTML=''; }
    });
    const apply=document.getElementById('apply-btn'); if(apply) apply.innerText=`Применить (${state.selectedTopics.length})`;
    lucide.createIcons();
}
function updateSelectAllButtonUI() {
    const btn=document.getElementById('select-all-btn'); if(!btn)return;
    const all=state.selectedTopics.length===availableTopics.length;
    btn.innerHTML=`<span>${all?'Снять выделение':'Выбрать все'}</span><i data-lucide="${all?'trash-2':'layers'}" class="w-4 h-4"></i>`;
    lucide.createIcons();
}

function getFilteredQuestions(mode) {
    let q = QUESTIONS_DATA.filter(x => state.selectedTopics.includes(x.topic));
    if (mode==='mistakes') q = q.filter(x => state.userProgress[x.id]?.status==='wrong');
    return q;
}
function startMode(mode, resume=false) {
    haptic('medium');
    if(resume && state.resumeState?.mode===mode){ state.view=mode; render(); return; }
    let q = getFilteredQuestions(mode);
    if(!q.length){ alert("Нет вопросов!"); return; }
    if((mode==='quiz'||mode==='cards') && state.isShuffleEnabled) q = [...q].sort(()=>Math.random()-0.5);
    state.playableQuestions=q; state.currentQuestionIndex=0; state.quizFinished=false;
    state.view=mode; state.sessionAnswers={}; state.resumeState=null; resetQuestionState(); render();
}
function resetQuestionState() { state.selectedOptions=[]; state.isAnswerChecked=false; state.lastResult=false; state.isFlipped=false; state.swipeX=0; state.animState='idle'; }
function saveCurrentState() { state.sessionAnswers[state.currentQuestionIndex] = { selectedOptions: [...state.selectedOptions], isAnswerChecked: state.isAnswerChecked, lastResult: state.lastResult }; }
function loadStateForIndex(i) {
    if(state.sessionAnswers[i]) { const s=state.sessionAnswers[i]; state.selectedOptions=s.selectedOptions; state.isAnswerChecked=s.isAnswerChecked; state.lastResult=s.lastResult; }
    else resetQuestionState();
}
function handleOptionSelect(idx) {
    if(state.isAnswerChecked) return; haptic('light');
    if(state.selectedOptions.includes(idx)) state.selectedOptions=state.selectedOptions.filter(x=>x!==idx); else state.selectedOptions.push(idx);
    render();
}
function checkAnswer() {
    if(!state.selectedOptions.length) return;
    state.isAnswerChecked=true; const q=state.playableQuestions[state.currentQuestionIndex];
    const sel=[...state.selectedOptions].sort().toString(), corr=[...q.correctIndices].sort().toString();
    state.lastResult=(sel===corr); haptic(state.lastResult?'success':'error');
    state.userProgress[q.id]={ status: state.lastResult?'correct':'wrong', attempts: (state.userProgress[q.id]?.attempts||0)+1 };
    saveCurrentState(); render();
}
function nextQuestion() {
    haptic('light'); saveCurrentState();
    if(state.currentQuestionIndex<state.playableQuestions.length-1) { state.currentQuestionIndex++; loadStateForIndex(state.currentQuestionIndex); document.querySelector('.layout-content').scrollTop=0; }
    else state.quizFinished=true;
    render();
}
function prevQuestion() {
    haptic('light'); saveCurrentState();
    if(state.currentQuestionIndex>0) { state.currentQuestionIndex--; loadStateForIndex(state.currentQuestionIndex); }
    render();
}
function goHome() {
    haptic('medium');
    if(['quiz','cards','mistakes'].includes(state.view) && !state.quizFinished && state.playableQuestions.length) state.resumeState={mode:state.view, index:state.currentQuestionIndex, questions:state.playableQuestions};
    else state.resumeState=null;
    state.view='menu'; render();
}

function render() {
    const app=document.getElementById('app');
    let scrollTop=0; const cd=document.querySelector('.layout-content');
    if(cd && app.dataset.view===state.view) scrollTop=cd.scrollTop;
    app.dataset.view=state.view;

    let bodyHTML=''; let footerHTML='';
    if(state.view==='menu') bodyHTML=renderMenuContent();
    else if(state.view==='learn') bodyHTML=renderLearnContent();
    else if(state.view==='quiz'||state.view==='mistakes') { bodyHTML=renderQuizContent(); footerHTML=renderQuizFooter(); }
    else if(state.view==='cards') { bodyHTML=renderCardsContent(); footerHTML=renderCardsFooter(); }
    
    app.innerHTML = `${renderHeader()}<div class="layout-content bg-slate-50 dark:bg-black">${bodyHTML}</div>${footerHTML}${state.showFilterModal?renderFilterModal():''}`;
    
    if(state.view==='cards') setTimeout(initCardEvents,0);
    if(cd && scrollTop>0) document.querySelector('.layout-content').scrollTop=scrollTop;
    lucide.createIcons();
}

// -----------------------------------------------------------
// ХЕДЕР: ЛОГО СЛЕВА, КНОПКИ СПРАВА, УМЕНЬШЕНО
// -----------------------------------------------------------
function renderHeader() {
    const isHome=state.view==='menu';
    return `<div class="layout-header bg-slate-50 dark:bg-black shadow-sm">
        <div class="flex items-center gap-3">
            ${!isHome?`<button onclick="goHome()" class="p-1 -ml-1 rounded-full hover:bg-slate-200 dark:hover:bg-slate-800 text-slate-800 dark:text-white btn-click"><i data-lucide="chevron-left" class="w-6 h-6"></i></button>`:''}
            <div onclick="goHome()" class="flex items-center gap-2 cursor-pointer group btn-click">
                <!-- УМЕНЬШЕННЫЙ ЛОГОТИП -->
                <div class="transition-transform group-hover:scale-105"><img src="${state.isDark?"https://i.ibb.co/tw2sGMTs/image.png":"https://i.ibb.co/zWn4xWnk/image.png"}" class="w-8 h-8 object-contain rounded-lg shadow-sm"></div>
                <span class="font-bold text-lg text-black dark:text-white flex items-baseline"><span class="font-serif mr-[1px]">I</span>med</span>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <button onclick="window.location.reload()" class="p-2 text-slate-500 hover:text-black dark:text-slate-400 dark:hover:text-white btn-click"><i data-lucide="rotate-cw" class="w-5 h-5"></i></button>
            <button onclick="toggleTheme()" class="p-2 text-slate-500 hover:text-black dark:text-slate-400 dark:hover:text-white btn-click"><i data-lucide="${state.isDark?'sun':'moon'}" class="w-6 h-6"></i></button>
            <a href="https://t.me/stewonly" target="_blank" class="p-2 text-slate-500 hover:text-[#2AABEE] dark:text-slate-400 dark:hover:text-[#2AABEE] btn-click"><i data-lucide="send" class="w-5 h-5"></i></a>
        </div>
    </div>`;
}

function renderMenuContent() {
    const learned=Object.values(state.userProgress).filter(p=>p.status==='correct').length;
    const errors=Object.values(state.userProgress).filter(p=>p.status==='wrong').length;
    const allSel=state.selectedTopics.length===availableTopics.length;
    return `<div class="p-4 space-y-6 animate-fade-in pb-10">
        <div class="bg-black dark:bg-slate-900 rounded-[2rem] p-8 text-white shadow-soft dark:shadow-none relative overflow-hidden">
            <div class="relative z-10">
                <h1 class="text-3xl font-black mb-2 tracking-tight">Физиология</h1>
                <p class="text-slate-400 font-medium text-sm mb-8">База: ${QUESTIONS_DATA.length} вопросов</p>
                <button onclick="toggleFilterModal(true)" class="flex items-center gap-3 text-xs font-bold bg-white/10 hover:bg-white/20 active:scale-95 w-fit px-5 py-3 rounded-xl border border-white/10 btn-click"><i data-lucide="filter" class="w-4 h-4"></i><span>${allSel?'Все темы':`${state.selectedTopics.length} выбрано`}</span></button>
            </div>
            <div class="absolute -right-6 -bottom-6 w-32 h-32 bg-white/10 rounded-full blur-2xl pointer-events-none"></div>
        </div>
        ${state.resumeState ? `<button onclick="startMode('${state.resumeState.mode}', true)" class="w-full bg-indigo-600 text-white p-5 rounded-[2rem] shadow-lg shadow-indigo-200 dark:shadow-none flex items-center justify-between group active:scale-[0.98] animate-slide-up btn-click"><div class="flex items-center gap-4"><div class="bg-white/20 p-3 rounded-2xl"><i data-lucide="play-circle" class="w-6 h-6"></i></div><div class="text-left"><span class="block font-black text-lg">Продолжить</span><span class="text-indigo-100 text-xs font-bold uppercase tracking-wide">${state.resumeState.mode==='quiz'?'Тест':(state.resumeState.mode==='cards'?'Карточки':'Ошибки')} • Вопрос ${state.resumeState.index+1}</span></div></div><i data-lucide="chevron-right" class="w-5 h-5"></i></button>`:''}
        <div class="space-y-4">
            <button onclick="startMode('learn')" class="w-full bg-white dark:bg-slate-900 p-5 rounded-[2rem] border border-slate-200 dark:border-slate-800 shadow-soft hover:shadow-lg flex justify-between items-center group active:scale-[0.98] btn-click"><div class="flex items-center gap-5"><div class="bg-yellow-100 dark:bg-yellow-900/30 p-4 rounded-2xl text-yellow-700 dark:text-yellow-400"><i data-lucide="book-open" class="w-6 h-6"></i></div><div class="text-left"><span class="block font-black text-slate-900 dark:text-white text-lg">Конспект</span><span class="text-slate-500 dark:text-slate-400 text-xs font-bold uppercase">Учить вопросы</span></div></div><i data-lucide="chevron-right" class="w-5 h-5 text-slate-300 dark:text-slate-600"></i></button>
            <button onclick="startMode('quiz')" class="w-full bg-white dark:bg-slate-900 p-5 rounded-[2rem] border border-slate-200 dark:border-slate-800 shadow-soft hover:shadow-lg flex justify-between items-center group active:scale-[0.98] btn-click"><div
